var received = false;

function poll() {
    var sleep = time => new Promise(resolve => setTimeout(resolve, time))
    var poll = (promiseFn, time) => promiseFn().then(sleep(time).then(() => poll(promiseFn, time)))
    poll(() => new Promise(() => {
        if (!received) {
            received = true;
            const http = new XMLHttpRequest();
            http.open('GET', 'getsettings');
            http.send();
            http.onload = () => {
                console.log(http.responseText);
                var prefs = JSON.parse(http.responseText);
                console.log(prefs);
                $('#deviceName').val(prefs.deviceName);
                $('#microcontrollerIP').val(prefs.ip);
                if (prefs.dhcp == '1') {
                    document.getElementById('microcontrollerIP').disabled = true;
                } else {
                    $("#dhcpCheckbox").click();
                }
                if (prefs.mqttIp.length == 0) {
                    $("#mqttCheckbox").click();
                }
                $('#inputMqttIp').val(prefs.mqttIp);
                $('#ssid').val(prefs.ssid);
                $('#wifipwd').val("***************");
                $('#mqttPort').val(prefs.mqttPort);
                $('#mqttTopic').val(prefs.mqttTopic);
                $('#mqttuser').val(prefs.mqttuser);
                $('#mqttpass').val(prefs.mqttpass);
                $('#lednum').val(prefs.lednum);
                $('#additionalParam').val(prefs.gpio);
                $('#gpioClock').val(prefs.gpioClock);
                $('#colorMode').val(prefs.colorMode);
                $('#colorOrder').val(prefs.colorOrder);
                $('#br').val(prefs.br);
                if (prefs.colorMode == '5') {
                    $("#clock").show();
                } else {
                    $("#clock").hide();
                }
            }
        }
    }), 5000);
}
function callDevice() {
    var payload = {
        deviceName: encodeURIComponent($('#deviceName').val()),
        microcontrollerIP: ($("#dhcpCheckbox").prop("checked") ? '' : $('#microcontrollerIP').val()),
        ssid: encodeURIComponent($('#ssid').val()),
        wifipwd: ($('#wifipwd').val() != "***************") ? encodeURIComponent($('#wifipwd').val()) : "",
        mqttCheckbox: $("#mqttCheckbox").prop("checked"),
        mqttIP: $('#inputMqttIp').val(),
        mqttPort: $('#mqttPort').val(),
        mqttTopic: encodeURIComponent($('#mqttTopic').val()),
        mqttuser: encodeURIComponent($('#mqttuser').val()),
        mqttpass: encodeURIComponent($('#mqttpass').val()),
        additionalParam: $('#additionalParam').val(),
        gpioClock: $('#gpioClock').val(),
        colorMode: $('#colorMode').val(),
        colorOrder: $('#colorOrder').val(),
        br: $('#br').val(),
        lednum: $('#lednum').val()
    }
    console.log(payload);
    const http = new XMLHttpRequest();
    http.open('GET', 'setting?payload=' + JSON.stringify(payload));
    http.send();
    http.onload = () => {
        console.log(http.responseText);
        alert("Success: rebooting the microcontroller");
        return false;
    };
}
function mqttCheckboxAction(cbMqtt, cbDhcp) {
    if (cbMqtt.checked) {
        document.getElementById('inputMqttIp').setAttribute('required', '');
        document.getElementById('mqttPort').setAttribute('required', '');
        document.getElementById('mqttTopic').setAttribute('required', '');
        document.getElementById('inputMqttIp').disabled = false;
        document.getElementById('mqttPort').disabled = false;
        document.getElementById('mqttTopic').disabled = false;
        document.getElementById('mqttuser').disabled = false;
        document.getElementById('mqttpass').disabled = false;
        document.getElementById('inputMqttIp').disabled = false;
    } else {
        document.getElementById('inputMqttIp').removeAttribute('required');
        document.getElementById('inputMqttIp').disabled = true;
        document.getElementById('mqttPort').removeAttribute('required');
        document.getElementById('mqttPort').disabled = true;
        document.getElementById('mqttPort').value = "";
        document.getElementById('mqttPort').disabled = true;
        document.getElementById('mqttTopic').removeAttribute('required');
        document.getElementById('mqttTopic').disabled = true;
        document.getElementById('mqttTopic').value = "";
        document.getElementById('mqttTopic').disabled = true;
        document.getElementById('mqttuser').value = "";
        document.getElementById('mqttuser').disabled = true;
        document.getElementById('mqttpass').value = "";
        document.getElementById('mqttpass').disabled = true;
        document.getElementById('inputMqttIp').value = "";
        document.getElementById('inputMqttIp').disabled = true;
    }
    if (cbDhcp.checked) {
        document.getElementById('microcontrollerIP').disabled = true;
    } else {
        document.getElementById('microcontrollerIP').disabled = false;
    }
}
const sleep = (s) => {
    return new Promise(resolve => setTimeout(resolve, (s)));
};
sleep(100).then(() => {
    poll();
    $('#colorMode').append(new Option("RGB", "1"));
    $('#colorMode').append(new Option("RGBW", "2"));
    $('#colorMode').append(new Option("RGBW (Brighter)", "3"));
    $('#colorMode').append(new Option("RGBW (RGB only)", "4"));
    $('#colorMode').append(new Option("DotStar", "5"));

    $('#colorOrder').append(new Option("GRB", "1"));
    $('#colorOrder').append(new Option("RGB", "2"));
    $('#colorOrder').append(new Option("BGR", "3"));
    $('#colorOrder').append(new Option("BRG", "4"));
    $('#colorOrder').append(new Option("RBG", "5"));
    $('#colorOrder').append(new Option("GBR", "6"));

    $('#br').append(new Option("115200", "8"));
    $('#br').append(new Option("230400", "1"));
    $('#br').append(new Option("460800", "2"));
    $('#br').append(new Option("500000", "3"));
    $('#br').append(new Option("921600", "4"));
    $('#br').append(new Option("1000000", "5"));
    $('#br').append(new Option("1500000", "6"));
    $('#br').append(new Option("2000000", "7"));
});
$('#colorMode').change(function(){
    var data= $(this).val();
    if (data == 5) {
        $("#clock").show();
    } else {
        $("#clock").hide();
    }
});
