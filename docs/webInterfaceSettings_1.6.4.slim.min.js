var mqttErrorShown = false;
var received = false;

$('.container').html(`
  <div class='row'>
        <div class='col' class=margin-2'>
            <button onclick="window.location.href='setldr'" type="button"
                    class="btn right-btn btn-outline-warning waves-effect px-3 sticky-top position-fixed"><i
                    class="fas fa-sun"></i></button>
            <form onsubmit='callDevice(); return false;'><br>
                <div class="form-group"><label for="deviceName">Device Name *</label> <input type="deviceName"
                                                                                             class="form-control"
                                                                                             id="deviceName"
                                                                                             aria-describedby="deviceName"
                                                                                             required></div>
                <br>
                <div class="form-check"><input type="checkbox" class="form-check-input" id="dhcpCheckbox" checked>
                    <label class="form-check-label" for="dhcpCheckbox">Enable DHCP</label></div>
                <div id='dhcpclass'>
                    <div class="form-group"><label for="microcontrollerIP">IP address</label> <input type="text"
       id="microcontrollerIP"
       inputmode="numeric"
       pattern="^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)(\\.|$)){4}$"
                                                                                                     class="form-control"
                                                                                                     id="microcontrollerIP">
                    </div>
                </div>
                <br>
                <div id="enEth" class="form-check"><input type="checkbox" class="form-check-input" id="ethCbx"> <label
                        class="form-check-label" for="ethCbx">Enable Ethernet</label></div>
                <div class='form-floating' id="eth"><select class='form-select' id='ethd'> </select> <label for='ethd'>Ethernet
                    device</label></div>
                <div id='wifi'>
                    <div class="form-group"><label for="ssid">Network name</label> <input type="text"
                                                                                          class="form-control"
                                                                                          id="ssid"></div>
                    <div class="form-group"><label for="wifipwd">WiFi password</label> <input type="password"
                                                                                              class="form-control"
                                                                                              id="wifipwd"></div>
                </div>
                <br>
                <div class="form-check"><input type="checkbox" class="form-check-input" id="mqttCheckbox" checked>
                    <label class="form-check-label" for="mqttCheckbox">Enable MQTT</label></div>
                <div id='mqttclass'>
                    <div class="form-group"><label for="inputMqttIp">MQTT server IP *</label> <input type="text"
                                                                                                     class="form-control"
                                                                                                     id="inputMqttIp">
                    </div>
                    <div class="form-group"><label for="mqttPort">MQTT server port *</label> <input type="number"
                                                                                                    class="form-control"
                                                                                                    id="mqttPort"></div>
                    <div class="form-group"><label for="mqttTopic">MQTT topic *</label> <input type="text"
                                                                                               class="form-control"
                                                                                               id="mqttTopic"></div>
                    <div class="form-group"><label for="mqttuser">MQTT server username</label> <input type="text"
                                                                                                      class="form-control"
                                                                                                      id="mqttuser">
                    </div>
                    <div class="form-group"><label for="mqttpass">MQTT server password</label> <input type="password"
                                                                                                      class="form-control"
                                                                                                      id="mqttpass">
                    </div>
                </div>
                <br>
                <div class='col-sm-12'>
                    <div class='form-floating'><select class='form-select' id='br'> </select> <label for='br'>BAUD
                        RATE</label></div>
                </div>
                <div class="form-group"><label for="lednum">LEDs number*</label> <input type="number" class="form-control"
                                                                                        id="lednum" required></div>
                <div class='col-sm-12'>
                    <div class='form-floating'><select class='form-select' id='colorMode'> </select> <label
                            for='colorMode'>COLOR MODE</label></div>
                </div>
                <div class='col-sm-12'>
                    <div class='form-floating'><select class='form-select' id='colorOrder'> </select> <label
                            for='colorOrder'>COLOR ORDER</label></div>
                </div>
                <div class="form-group"><label for="additionalParam">GPIO PIN for the LED strip*</label> <input
                        type="number" class="form-control" id="additionalParam" required></div>
                <div id="clock" class="form-group"><label for="gpioClock">GPIO CLOCK PIN for the LED strip</label>
                    <input type="number" class="form-control" id="gpioClock"></div>
                <br><br>
                <button type="submit" class="btn btn-orange"> SAVE SETTINGS</button>
                <button onclick="window.location.href='/'" type="button"
                        class="btn back-btn btn-outline-warning waves-effect px-3 sticky-top position-fixed"><i
                        class="fas fa-arrow-left" aria-hidden="true"></i></button>
                <br><br><br></form>
        </div>
    </div>
`);

const customEthHtml = `
<div id="customEthGpios" style="display:none; margin-top:10px;">
  <div class="row g-2">
    <div class="col-3 form-floating">
      <input type="number" class="form-control form-control-sm" id="miso" placeholder="MISO">
      <label for="miso">MISO</label>
    </div>

    <div class="col-3 form-floating">
      <input type="number" class="form-control form-control-sm" id="mosi" placeholder="MOSI">
      <label for="mosi">MOSI</label>
    </div>

    <div class="col-3 form-floating">
      <input type="number" class="form-control form-control-sm" id="sclk" placeholder="SCLK">
      <label for="sclk">SCLK</label>
    </div>

    <div class="col-3 form-floating">
      <input type="number" class="form-control form-control-sm" id="cs" placeholder="CS">
      <label for="cs">CS</label>
    </div>
  </div>
</div>
`;

$('#eth').after(customEthHtml);

$('#ethd').on('change', function () {
    const isCustom = $(this).val() === '100';
    $('#customEthGpios').toggle(isCustom);
    $('#mosi, #miso, #sclk, #cs').prop('required', isCustom);
});

function poll() {
    var poll = (promiseFn, time) => promiseFn().then(sleep(time).then(() => poll(promiseFn, time)))
    poll(() => new Promise(() => {
        if (!received) {
            received = true;
            const http = new XMLHttpRequest();
            http.open('GET', 'getsettings');
            http.send();
            http.onload = () => {
                console.log(http.responseText);
                var prefs = JSON.parse(http.responseText);
                // console.log(prefs);
                if (prefs.mqttError == '1' && !mqttErrorShown) {
                    showToast('Can\'t connect to the MQTT server', 'bg-danger text-white');
                    mqttErrorShown = true;
                } else if ((prefs.mqttError == null || prefs.mqttError == '0') && mqttErrorShown) {
                    showToast('MQTT connected', 'bg-success text-white');
                    mqttErrorShown = false;
                }
                $('#deviceName').val(prefs.deviceName);
                $('#microcontrollerIP').val(prefs.ip);
                if (prefs.dhcp == '1') {
                    document.getElementById('microcontrollerIP').disabled = true;
                } else {
                    $("#dhcpCheckbox").click();
                }
                if (prefs.mqttIp.length == 0) {
                    $("#mqttCheckbox").click();
                }
                if (prefs.ethd >= 1) {
                    $("#ethCbx").click();
                    const isCustom = prefs.ethd === '100';
                    $('#customEthGpios').toggle(isCustom);
                    $('#mosi, #miso, #sclk, #cs').prop('required', isCustom);
                }
                if (prefs.ethd == -1) {
                    $("#enEth").hide();
                }
                if (prefs.ethd == -1 || prefs.ethd == 0) {
                    $("#eth").hide();
                }
                $('#ethd').val(prefs.ethd);
                $('#mosi').val(prefs.mosi);
                $('#miso').val(prefs.miso);
                $('#sclk').val(prefs.sclk);
                $('#cs').val(prefs.cs);
                $('#inputMqttIp').val(prefs.mqttIp);
                $('#ssid').val(prefs.ssid);
                $('#wifipwd').val("***************");
                $('#mqttPort').val(prefs.mqttPort);
                $('#mqttTopic').val(prefs.mqttTopic);
                $('#mqttuser').val(prefs.mqttuser);
                $('#mqttpass').val(prefs.mqttpass);
                $('#lednum').val(prefs.lednum);
                $('#additionalParam').val(prefs.gpio);
                $('#gpioClock').val(prefs.gpioClock);
                $('#colorMode').val(prefs.colorMode);
                $('#colorOrder').val(prefs.colorOrder);
                $('#br').val(prefs.br);
                if (prefs.colorMode == '5') {
                    $("#clock").show();
                } else {
                    $("#clock").hide();
                }
            }
        }
    }), 5000);
}

function callDevice() {
    var payload = {
        deviceName: encodeURIComponent($('#deviceName').val()),
        microcontrollerIP: ($("#dhcpCheckbox").prop("checked") ? '' : $('#microcontrollerIP').val()),
        ethd: ($("#ethCbx").prop("checked") ? $('#ethd').val() : 0),
        ssid: encodeURIComponent($('#ssid').val()),
        wifipwd: ($('#wifipwd').val() != "***************") ? encodeURIComponent($('#wifipwd').val()) : "",
        mqttCheckbox: $("#mqttCheckbox").prop("checked"),
        mqttIP: $('#inputMqttIp').val(),
        mqttPort: $('#mqttPort').val(),
        mqttTopic: encodeURIComponent($('#mqttTopic').val()),
        mqttuser: encodeURIComponent($('#mqttuser').val()),
        mqttpass: encodeURIComponent($('#mqttpass').val()),
        additionalParam: $('#additionalParam').val(),
        gpioClock: $('#gpioClock').val(),
        colorMode: $('#colorMode').val(),
        colorOrder: $('#colorOrder').val(),
        br: $('#br').val(),
        lednum: $('#lednum').val()
    }
    if ($('#ethd').val() == 100) {
        payload.mosi = $('#mosi').val();
        payload.miso = $('#miso').val();
        payload.sclk = $('#sclk').val();
        payload.cs = $('#cs').val();
    }
    console.log(payload);
    const http = new XMLHttpRequest();
    http.open('GET', 'setting?payload=' + JSON.stringify(payload));
    http.send();
    http.onload = () => {
        console.log(http.responseText);
        showToast('Success: rebooting the microcontroller', 'bg-success text-white');
        return false;
    };
}

function cbxAcn(cbMqtt, cbDhcp, cbEth) {
    if (cbMqtt.checked) {
        document.getElementById('inputMqttIp').setAttribute('required', '');
        document.getElementById('mqttPort').setAttribute('required', '');
        document.getElementById('mqttTopic').setAttribute('required', '');
        document.getElementById('inputMqttIp').disabled = false;
        document.getElementById('mqttPort').disabled = false;
        document.getElementById('mqttTopic').disabled = false;
        document.getElementById('mqttuser').disabled = false;
        document.getElementById('mqttpass').disabled = false;
        document.getElementById('inputMqttIp').disabled = false;
    } else {
        document.getElementById('inputMqttIp').removeAttribute('required');
        document.getElementById('inputMqttIp').disabled = true;
        document.getElementById('mqttPort').removeAttribute('required');
        document.getElementById('mqttPort').disabled = true;
        document.getElementById('mqttPort').value = "";
        document.getElementById('mqttPort').disabled = true;
        document.getElementById('mqttTopic').removeAttribute('required');
        document.getElementById('mqttTopic').disabled = true;
        document.getElementById('mqttTopic').value = "";
        document.getElementById('mqttTopic').disabled = true;
        document.getElementById('mqttuser').value = "";
        document.getElementById('mqttuser').disabled = true;
        document.getElementById('mqttpass').value = "";
        document.getElementById('mqttpass').disabled = true;
        document.getElementById('inputMqttIp').value = "";
        document.getElementById('inputMqttIp').disabled = true;
    }
    if (cbDhcp.checked) {
        document.getElementById('microcontrollerIP').disabled = true;
    } else {
        document.getElementById('microcontrollerIP').disabled = false;
    }
    if (cbEth.checked) {
        if ($('#ethd').val() === 0 || $('#ethd').val() === null) {
            $('#ethd').val(100);
        }
        $('#customEthGpios').toggle(true);
        $('#mosi, #miso, #sclk, #cs').prop('required', true);
        $("#eth").show();
        $("#wifi").hide();
    } else {
        $("#eth").hide();
        $("#wifi").show();
        $('#customEthGpios').hide();
        $('#mosi, #miso, #sclk, #cs').prop('required', false);
    }
}

const sleep = (s) => {
    return new Promise(resolve => setTimeout(resolve, (s)));
};
sleep(100).then(() => {
    $("#subtitle").text("Bias Lighting and Ambient Light firmware designed for Firefly Luciferin")
    poll();
    $('#colorMode').append(new Option("RGB", "1"));
    $('#colorMode').append(new Option("RGBW", "2"));
    $('#colorMode').append(new Option("RGBW (Brighter)", "3"));
    $('#colorMode').append(new Option("RGBW (RGB only)", "4"));
    $('#colorMode').append(new Option("DotStar", "5"));

    $('#colorOrder').append(new Option("GRB/GRBW", "1"));
    $('#colorOrder').append(new Option("RGB/RGBW", "2"));
    $('#colorOrder').append(new Option("BGR/BGRW", "3"));
    $('#colorOrder').append(new Option("BRG/BRGW", "4"));
    $('#colorOrder').append(new Option("RBG/RBGW", "5"));
    $('#colorOrder').append(new Option("GBR/GBRW", "6"));
    $('#colorOrder').append(new Option("GRWB", "7"));
    $('#colorOrder').append(new Option("GWBR", "8"));
    $('#colorOrder').append(new Option("WRBG", "9"));
    $('#colorOrder').append(new Option("RGWB", "10"));
    $('#colorOrder').append(new Option("RWBG", "11"));
    $('#colorOrder').append(new Option("WGBR", "12"));
    $('#colorOrder').append(new Option("BGWR", "13"));
    $('#colorOrder').append(new Option("BWRG", "14"));
    $('#colorOrder').append(new Option("WGRB", "15"));
    $('#colorOrder').append(new Option("BRWG", "16"));
    $('#colorOrder').append(new Option("BWGR", "17"));
    $('#colorOrder').append(new Option("WRGB", "18"));
    $('#colorOrder').append(new Option("RBWG", "19"));
    $('#colorOrder').append(new Option("RWGB", "20"));
    $('#colorOrder').append(new Option("WBGR", "21"));
    $('#colorOrder').append(new Option("GBWR", "22"));
    $('#colorOrder').append(new Option("GWRB", "23"));
    $('#colorOrder').append(new Option("WBRG", "24"));

    $('#br').append(new Option("115200", "8"));
    $('#br').append(new Option("230400", "1"));
    $('#br').append(new Option("460800", "2"));
    $('#br').append(new Option("500000", "3"));
    $('#br').append(new Option("921600", "4"));
    $('#br').append(new Option("1000000", "5"));
    $('#br').append(new Option("1500000", "6"));
    $('#br').append(new Option("2000000", "7"));
    $('#br').append(new Option("4000000", "9"));
    $('#br').append(new Option("6000000", "10"));

    $('#ethd').append(
        $('<optgroup>', {label: 'CUSTOM SPI board'})
    );
    $('#ethd').append(new Option("CUSTOM W5500 ethernet GPIOs", "100"));
    $('#ethd').append(
        $('<optgroup>', {label: 'SPI ethernet boards'})
    );
    $('#ethd').append(new Option("T-ETH ELite ESP32-S3", "101"));
    $('#ethd').append(new Option("T-ETH Lite ESP32-S3", "102"));
    $('#ethd').append(
        $('<optgroup>', {label: 'RMII ethernet boards'})
    );
    $('#ethd').append(new Option("QuinLed-ESP32-Ethernet", "1"));
    $('#ethd').append(new Option("QuinLed-Dig-Octa Brainboard-32-8L and LilyGO-T-ETH-POE", "2"));
    $('#ethd').append(new Option("LilyGO-T-POE-Pro", "7"));
    $('#ethd').append(new Option("WT32-ETH01", "3"));
    $('#ethd').append(new Option("ESP32-ETHERNET-KIT-VE", "4"));
    $('#ethd').append(new Option("ESP32-POE", "5"));
    $('#ethd').append(new Option("ESP32-POE-WROVER", "8"));
    $('#ethd').append(new Option("WESP32", "6"));

    var toastContainerHTML = `
    <div id="toastContainer" aria-live="polite" aria-atomic="true" style="position: relative;">
        <div style="position: absolute; top: 0; right: 0;"></div>
    </div>`;
    document.body.insertAdjacentHTML('beforeend', toastContainerHTML);
});
$('#colorMode').change(function () {
    var data = $(this).val();
    if (data == 5) {
        $("#clock").show();
    } else {
        $("#clock").hide();
    }
});

function showToast(message, contextClass) {
    // Aggiungi il container se non esiste gi√†
    if (!document.getElementById('toastContainer')) {
        addToastContainer();
    }
    var toastHTML = `
    <div class="toast ${contextClass}" role="alert" aria-live="assertive" aria-atomic="true" data-delay="5000" style="position: fixed; bottom: 10px; right: 10px; z-index: 1051;">
        <div class="toast-body">
            ${message}
        </div>
    </div>`;
    var toastContainer = document.getElementById('toastContainer').children[0];
    toastContainer.insertAdjacentHTML('beforeend', toastHTML);
    var toastElement = toastContainer.lastElementChild;
    $(toastElement).toast('show');
}

const cbMqtt = document.getElementById('mqttCheckbox');
const cbDhcp = document.getElementById('dhcpCheckbox');
const cbEth = document.getElementById('ethCbx');
cbMqtt.onclick = () => {
    cbxAcn(cbMqtt, cbDhcp, cbEth);
};
cbDhcp.onclick = () => {
    cbxAcn(cbMqtt, cbDhcp, cbEth);
};
cbEth.onclick = () => {
    cbxAcn(cbMqtt, cbDhcp, cbEth);
};

const now = new Date();
const year = now.getFullYear();

const start = new Date(year, 11, 14); 
const end = new Date(year + 1, 0, 1); 

const isChristmas = now >= start && now <= end;

if (isChristmas) {
  const snowContainer = document.createElement("div");
  snowContainer.id = "snow";
  document.body.appendChild(snowContainer);

const flakesCount =
  window.innerWidth >= 1200 ? 40 :
  window.innerWidth >= 992  ? 30 :
  window.innerWidth >= 768  ? 24 :
                              16;

  for (let i = 0; i < flakesCount; i++) {
    const flake = document.createElement("div");
    flake.className = "snowflake";
    flake.textContent = "\u2744\uFE0E";

    flake.style.left = Math.random() * 100 + "vw";
    flake.style.fontSize = 12 + Math.random() * 14 + "px";
    flake.style.opacity = Math.random();
    flake.style.animationDuration = 6 + Math.random() * 6 + "s";
    flake.style.animationDelay = Math.random() * 5 + "s";

    snowContainer.appendChild(flake);
  }
}




