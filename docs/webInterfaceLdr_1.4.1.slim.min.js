var mqttErrorShown = false;
var firstRun = true;

$('.container').html(`
 <div class='row'>
        <div class='col' class='margin-2'>
            <form onsubmit='callDeviceLdr(); return false;'><br><br>
                <div class="form-group"><label for="relayPin">Relay GPIO</label><input type="number"
                                                                                       class="form-control"
                                                                                       id="relayPin"><input
                        type="checkbox" class="form-check-input" id="relInv"> Invert relay
                </div>
                <br>
                <div class="form-group"><label for="sbPin">Smart button GPIO</label><input type="number"
                                                                                           class="form-control"
                                                                                           id="sbPin"></div>
                <br>
                <div class="form-group"><label for="ledBuiltin">LED built-in GPIO</label><input type="number"
                                                                                           class="form-control"
                                                                                           id="ledBuiltin"></div>                                                                                           
                <br>
                <div class="form-group"><label for="ldrPin">LDR GPIO</label><input type="number" class="form-control"
                                                                                   id="ldrPin"></div>
                <br>
                <div class="form-check"><input type="checkbox" class="form-check-input" id="ldrEnabled" checked><label
                        class="form-check-label" for="ldrEnabled">Enable Light Dependent Resistor (LDR)</label></div>
                <div>
                    <div class='col-sm-12'>
                        <div class='form-floating'><select class='form-select' id='ldrInterval'></select><label
                                for='ldrMin'>LDR reading interval</label></div>
                    </div>
                </div>
                <div class="form-check"><input type="checkbox" class="form-check-input" id="ldrTurnOff" checked><label
                        class="form-check-label" for="ldrTurnOff">Turn off LEDs during readings</label></div>
                <div>
                    <div class='col-sm-12'>
                        <div class='form-floating'><select class='form-select' id='ldrMin'></select><label for='ldrMin'>Min
                            Brightness</label></div>
                    </div>
                </div>
                <div class="container">
                    <div class="row">
                        <div class="col">
                            <button id="cal" type="button" class="btn btn-orange" onclick='calLDR()'>CALIBRATE LDR
                            </button>
                        </div>
                        <div class="col">
                            <button type="button" id="rst" class="btn btn-orange" onclick='resetLDR()'>RESET LDR
                            </button>
                        </div>
                    </div>
                </div>
                <br><br>
                <button type="submit" class="btn btn-orange"> SAVE SETTINGS</button>
                <button onclick="window.location.href='setsettings'" type="button"
                        class="btn back-btn btn-outline-warning waves-effect px-3 sticky-top position-fixed"><i
                        class="fas fa-arrow-left" aria-hidden="true"></i></button>
                <br><br><br></form>
        </div>
    </div>
`);

function evaluateValues() {
    if (!$('#ldrEnabled')[0].checked) {
        $('#ldrTurnOff')[0].checked = false;
        $('#ldrTurnOff')[0].disabled = true;
        $('#ldrInterval')[0].disabled = true;
        $('#ldrMin')[0].disabled = true;
        $('#cal')[0].disabled = true;
        $('#rst')[0].disabled = true;
    } else {
        $('#ldrInterval')[0].disabled = false;
        if ($("#ldrInterval").val() == 0) {
            $('#ldrTurnOff')[0].checked = false;
            $('#ldrTurnOff')[0].disabled = true;
        } else {
            $('#ldrTurnOff')[0].disabled = false;
        }
        $('#ldrMin')[0].disabled = false;
        $('#cal')[0].disabled = false;
        $('#rst')[0].disabled = false;
    }
}

function poll() {
    var poll = (promiseFn, time) => promiseFn().then(sleep(time).then(() => poll(promiseFn, time)))
    poll(() => new Promise(() => {
        const http = new XMLHttpRequest();
        http.open('GET', 'getLdr');
        http.send();
        http.onload = () => {
            console.log(http.responseText);
            var prefs = JSON.parse(http.responseText);
            console.log(prefs);
            if (prefs.mqttError == '1' && !mqttErrorShown) {
                showToast('Can\'t connect to the MQTT server', 'bg-danger text-white');
                mqttErrorShown = true;
            } else if ((prefs.mqttError == null || prefs.mqttError == '0') && mqttErrorShown) {
                showToast('MQTT connected', 'bg-success text-white');
                mqttErrorShown = false;
            }
            if (firstRun) {
                $('#ldrEnabled').val(prefs.ldrEnabled);
                $('#relInv').val(prefs.relInv);
                $('#ldrInterval').val(prefs.ldrInterval);
                $('#ldrMin').val(prefs.ldrMin);
                $('#relayPin').val(prefs.relayPin);
                $('#sbPin').val(prefs.sbPin);
                $('#ldrPin').val(prefs.ldrPin);
                $('#ledBuiltin').val(prefs.ledBuiltin);
                if (prefs.ldrEnabled == '1') {
                    $('#ldrEnabled').prop('checked', true);
                } else {
                    $('#ldrEnabled').prop('checked', false);
                }
                if (prefs.ldrTurnOff == '1') {
                    $('#ldrTurnOff').prop('checked', true);
                } else {
                    $('#ldrTurnOff').prop('checked', false);
                }
                if (prefs.relInv == '1') {
                    $('#relInv').prop('checked', true);
                } else {
                    $('#relInv').prop('checked', false);
                }
                evaluateValues();
                firstRun = false;
            }
            if (prefs.ldrMax) {
                $('#ldrgrp').show();
                $('#ldr').text(Math.round(prefs.ldrMax) + '%');
            } else {
                $('#ldrgrp').hide();
            }
        }
    }), 5000);
}
function callDeviceLdr(calibrateOrResetLDR) {
    var payload = {
        ldrEnabled: ($("#ldrEnabled").prop("checked") ? 'true' : 'false'),
        relInv: ($("#relInv").prop("checked") ? 'true' : 'false'),
        ldrTurnOff: ($("#ldrTurnOff").prop("checked") ? 'true' : 'false'),
        ldrInterval: $("#ldrInterval").val(),
        ldrMin: $('#ldrMin').val(),
        relayPin: $('#relayPin').val(),
        sbPin: $('#sbPin').val(),
        ldrPin: $('#ldrPin').val(),
        ledBuiltin: $('#ledBuiltin').val()
    }
    if (calibrateOrResetLDR != undefined) {
        payload.ldrAction = calibrateOrResetLDR;
    } else {
        payload.ldrAction = 4;
    }
    console.log(payload);
    const http = new XMLHttpRequest();
    http.open('GET', 'ldr?payload=' + JSON.stringify(payload));
    http.send();
    http.onload = () => {
        console.log(http.responseText);
        if (calibrateOrResetLDR == undefined) {            
            showToast('Success: rebooting the microcontroller', 'bg-success text-white');
        } else if (calibrateOrResetLDR == 2) {
            showToast('LDR CALIBRATION Success: rebooting the microcontroller', 'bg-success text-white');
        } else if (calibrateOrResetLDR == 3) {
            showToast('LDR RESET Success: rebooting the microcontroller', 'bg-success text-white');
        }
        return false;
    };
}
function calLDR() {
    if (confirm("Current brightness level of the room will be used as the maximum level from which to start adjusting the brightness of the LED strip. Calibration takes up to 5 seconds and will turn off the LEDs.")) {
        const http = new XMLHttpRequest();
        http.open('GET', 'set?payload={"state":"OFF","effect":"solid","allInstances":1}');
        http.send();
        http.onload = () => {
            sleep(4000).then(() => {
               callDeviceLdr(2)
            });
        }
    }
}
function resetLDR() {
    if (confirm("Are you sure you want to continue? LDR calibration will be reset.")) {
        callDeviceLdr(3);
    }
}
const sleep = (s) => {
    return new Promise(resolve => setTimeout(resolve, (s)));
};
sleep(100).then(() => {
    $("#subtitle").text("Bias Lighting and Ambient Light firmware designed for Firefly Luciferin")
    poll();
    $('#ldrMin').append(new Option("10%", "10"));
    $('#ldrMin').append(new Option("20%", "20"));
    $('#ldrMin').append(new Option("30%", "30"));
    $('#ldrMin').append(new Option("40%", "40"));
    $('#ldrMin').append(new Option("50%", "50"));
    $('#ldrMin').append(new Option("60%", "60"));
    $('#ldrMin').append(new Option("70%", "70"));
    $('#ldrMin').append(new Option("80%", "80"));
    $('#ldrMin').append(new Option("90%", "90"));
    $('#ldrMin').append(new Option("100%", "100"));

    $('#ldrInterval').append(new Option("Continuous", "0"));
    $('#ldrInterval').append(new Option("10 minutes", "10"));
    $('#ldrInterval').append(new Option("20 minutes", "20"));
    $('#ldrInterval').append(new Option("30 minutes", "30"));
    $('#ldrInterval').append(new Option("40 minutes", "40"));
    $('#ldrInterval').append(new Option("50 minutes", "50"));
    $('#ldrInterval').append(new Option("60 minutes", "60"));
    $('#ldrInterval').append(new Option("120 minutes", "120"));

    $("#ldrEnabled").click(function () {
        evaluateValues();
    });
    $("#ldrInterval").change(function () {
        evaluateValues();
    });
    var toastContainerHTML = `
    <div id="toastContainer" aria-live="polite" aria-atomic="true" style="position: relative;">
        <div style="position: absolute; top: 0; right: 0;"></div>
    </div>`;
    document.body.insertAdjacentHTML('beforeend', toastContainerHTML);
});

function showToast(message, contextClass) {
    // Aggiungi il container se non esiste già
    if (!document.getElementById('toastContainer')) {
        addToastContainer();
    }
    var toastHTML = `
    <div class="toast ${contextClass}" role="alert" aria-live="assertive" aria-atomic="true" data-delay="5000" style="position: fixed; bottom: 10px; right: 10px; z-index: 1051;">
        <div class="toast-body">
            ${message}
        </div>
    </div>`;
    var toastContainer = document.getElementById('toastContainer').children[0];
    toastContainer.insertAdjacentHTML('beforeend', toastHTML);
    var toastElement = toastContainer.lastElementChild;
    $(toastElement).toast('show');
}

const now = new Date();
const month = now.getMonth(); 
const day = now.getDate();

const isChristmas = (month === 11 && day >= 14) || (month === 0  && day <= 6);    

if (isChristmas) {
  const snowContainer = document.createElement("div");
  snowContainer.id = "snow";
  document.body.appendChild(snowContainer);

  const flakesCount =
    window.innerWidth >= 1200 ? 40 :
    window.innerWidth >= 992  ? 30 :
    window.innerWidth >= 768  ? 24 :
                                16;

  for (let i = 0; i < flakesCount; i++) {
    const flake = document.createElement("div");
    flake.className = "snowflake";
    flake.textContent = "❄";

    flake.style.left = Math.random() * 100 + "vw";
    flake.style.fontSize = 12 + Math.random() * 14 + "px";
    flake.style.opacity = Math.random();
    flake.style.animationDuration = 6 + Math.random() * 6 + "s";
    flake.style.animationDelay = Math.random() * 5 + "s";

    snowContainer.appendChild(flake);
  }
}
