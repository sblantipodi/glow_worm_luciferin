var mqttErrorShown = false;
var firstRun = true;

function evaluateValues() {
    if (!$('#ldrEnabled')[0].checked) {
        $('#ldrTurnOff')[0].checked = false;
        $('#ldrTurnOff')[0].disabled = true;
        $('#ldrInterval')[0].disabled = true;
        $('#ldrMin')[0].disabled = true;
        $('#cal')[0].disabled = true;
        $('#rst')[0].disabled = true;
    } else {
        $('#ldrInterval')[0].disabled = false;
        if ($("#ldrInterval").val() == 0) {
            $('#ldrTurnOff')[0].checked = false;
            $('#ldrTurnOff')[0].disabled = true;
        } else {
            $('#ldrTurnOff')[0].disabled = false;
        }
        $('#ldrMin')[0].disabled = false;
        $('#cal')[0].disabled = false;
        $('#rst')[0].disabled = false;
    }
}

function poll() {
    var poll = (promiseFn, time) => promiseFn().then(sleep(time).then(() => poll(promiseFn, time)))
    poll(() => new Promise(() => {
        const http = new XMLHttpRequest();
        http.open('GET', 'getLdr');
        http.send();
        http.onload = () => {
            console.log(http.responseText);
            var prefs = JSON.parse(http.responseText);
            console.log(prefs);
            if (prefs.mqttError == '1' && !mqttErrorShown) {
                showToast('Can\'t connect to the MQTT server', 'bg-danger text-white');
                mqttErrorShown = true;
            } else if ((prefs.mqttError == null || prefs.mqttError == '0') && mqttErrorShown) {
                showToast('MQTT connected', 'bg-success text-white');
                mqttErrorShown = false;
            }
            if (firstRun) {
                $('#ldrEnabled').val(prefs.ldrEnabled);
                $('#relInv').val(prefs.relInv);
                $('#ldrInterval').val(prefs.ldrInterval);
                $('#ldrMin').val(prefs.ldrMin);
                $('#relayPin').val(prefs.relayPin);
                $('#sbPin').val(prefs.sbPin);
                $('#ldrPin').val(prefs.ldrPin);
                if (prefs.ldrEnabled == '1') {
                    $('#ldrEnabled').prop('checked', true);
                } else {
                    $('#ldrEnabled').prop('checked', false);
                }
                if (prefs.ldrTurnOff == '1') {
                    $('#ldrTurnOff').prop('checked', true);
                } else {
                    $('#ldrTurnOff').prop('checked', false);
                }
                if (prefs.relInv == '1') {
                    $('#relInv').prop('checked', true);
                } else {
                    $('#relInv').prop('checked', false);
                }
                evaluateValues();
                firstRun = false;
            }
            if (prefs.ldrMax) {
                $('#ldrgrp').show();
                $('#ldr').text(Math.round(prefs.ldrMax) + '%');
            } else {
                $('#ldrgrp').hide();
            }
        }
    }), 5000);
}
function callDeviceLdr(calibrateOrResetLDR) {
    var payload = {
        ldrEnabled: ($("#ldrEnabled").prop("checked") ? 'true' : 'false'),
        relInv: ($("#relInv").prop("checked") ? 'true' : 'false'),
        ldrTurnOff: ($("#ldrTurnOff").prop("checked") ? 'true' : 'false'),
        ldrInterval: $("#ldrInterval").val(),
        ldrMin: $('#ldrMin').val(),
        relayPin: $('#relayPin').val(),
        sbPin: $('#sbPin').val(),
        ldrPin: $('#ldrPin').val()
    }
    if (calibrateOrResetLDR != undefined) {
        payload.ldrAction = calibrateOrResetLDR;
    } else {
        payload.ldrAction = 4;
    }
    console.log(payload);
    const http = new XMLHttpRequest();
    http.open('GET', 'ldr?payload=' + JSON.stringify(payload));
    http.send();
    http.onload = () => {
        console.log(http.responseText);
        if (calibrateOrResetLDR == undefined) {            
            showToast('Success: rebooting the microcontroller', 'bg-success text-white');
        } else if (calibrateOrResetLDR == 2) {
            showToast('LDR CALIBRATION Success: rebooting the microcontroller', 'bg-success text-white');
        } else if (calibrateOrResetLDR == 3) {
            showToast('LDR RESET Success: rebooting the microcontroller', 'bg-success text-white');
        }
        return false;
    };
}
function calLDR() {
    if (confirm("Current brightness level of the room will be used as the maximum level from which to start adjusting the brightness of the LED strip. Calibration takes up to 5 seconds and will turn off the LEDs.")) {
        const http = new XMLHttpRequest();
        http.open('GET', 'set?payload={"state":"OFF","effect":"solid","allInstances":1}');
        http.send();
        http.onload = () => {
            sleep(4000).then(() => {
               callDeviceLdr(2)
            });
        }
    }
}
function resetLDR() {
    if (confirm("Are you sure you want to continue? LDR calibration will be reset.")) {
        callDeviceLdr(3);
    }
}
const sleep = (s) => {
    return new Promise(resolve => setTimeout(resolve, (s)));
};
sleep(100).then(() => {
    $("#subtitle").text("Bias Lighting and Ambient Light firmware designed for Firefly Luciferin")
    poll();
    $('#ldrMin').append(new Option("10%", "10"));
    $('#ldrMin').append(new Option("20%", "20"));
    $('#ldrMin').append(new Option("30%", "30"));
    $('#ldrMin').append(new Option("40%", "40"));
    $('#ldrMin').append(new Option("50%", "50"));
    $('#ldrMin').append(new Option("60%", "60"));
    $('#ldrMin').append(new Option("70%", "70"));
    $('#ldrMin').append(new Option("80%", "80"));
    $('#ldrMin').append(new Option("90%", "90"));
    $('#ldrMin').append(new Option("100%", "100"));

    $('#ldrInterval').append(new Option("Continuous", "0"));
    $('#ldrInterval').append(new Option("10 minutes", "10"));
    $('#ldrInterval').append(new Option("20 minutes", "20"));
    $('#ldrInterval').append(new Option("30 minutes", "30"));
    $('#ldrInterval').append(new Option("40 minutes", "40"));
    $('#ldrInterval').append(new Option("50 minutes", "50"));
    $('#ldrInterval').append(new Option("60 minutes", "60"));
    $('#ldrInterval').append(new Option("120 minutes", "120"));

    $("#ldrEnabled").click(function () {
        evaluateValues();
    });
    $("#ldrInterval").change(function () {
        evaluateValues();
    });
    var toastContainerHTML = `
    <div id="toastContainer" aria-live="polite" aria-atomic="true" style="position: relative;">
        <div style="position: absolute; top: 0; right: 0;"></div>
    </div>`;
    document.body.insertAdjacentHTML('beforeend', toastContainerHTML);
});

function showToast(message, contextClass) {
    // Aggiungi il container se non esiste gi√†
    if (!document.getElementById('toastContainer')) {
        addToastContainer();
    }
    var toastHTML = `
    <div class="toast ${contextClass}" role="alert" aria-live="assertive" aria-atomic="true" data-delay="5000" style="position: fixed; bottom: 10px; right: 10px; z-index: 1051;">
        <div class="toast-body">
            ${message}
        </div>
    </div>`;
    var toastContainer = document.getElementById('toastContainer').children[0];
    toastContainer.insertAdjacentHTML('beforeend', toastHTML);
    var toastElement = toastContainer.lastElementChild;
    $(toastElement).toast('show');
}
